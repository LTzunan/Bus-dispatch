# Bus-dispatch

公交调度是指借助各站的等待人数和等待时间等数据，以公交公司的角度估计出各线路配车数量及发车间隔，尽可能地降低公交运营成本的过程。

![img](http://ltzunanimage.oss-cn-shenzhen.aliyuncs.com/img/clip_image002.jpg)

### 1. 数据集预处理

输入：从公众号上爬取的公交车Id号、日期、时间、站点Id、首末站停车时间、单程行驶时间等参数的集合。

输出：经过了初步处理和修饰的上述参数的集合。

主要过程：

1. 替换异常值:用平均值代替负值或明显异常的数据。
2. 合并节日数据:将周末及节假日特殊化。
3. 创建虚拟变量。
4. 调整目标变量:对各变量进行标准化和无量纲化，避免产生错误和影响，避免梯度下降步长消失。

***

Ps1：ceil 函数的作用是向上舍入最接近的整数值。

Ps2：merge 函数的作用是将不同数据集依照某些字段进行合并操作，得到一个新数据集。

Ps3：虚拟变量是一些原公式中不存在的变量，通常取0或1进行类逻辑运算，一般来反映单一条件存在与否对运算结果的影响，一般使用 get_dummies 函数。

Ps4：get_dummies 函数的作用是利用 pandas 库进行独热编码。

Ps5：独热编码即 One-Hot 编码，又称一位有效编码，其方法是使用N位状态寄存器来对N个状态进行编码，每个状态都有它独立的寄存器位，并且在任意时候，其中只有一位有效。

Ps6：无量纲化是指通过一个合适的变量替代，将一个涉及物理量的方程的部分或全部的单位移除，以求简化实验或者计算为目的的过程。

Ps7：数据同趋化处理主要解决不同性质数据问题，对不同性质指标直接加总不能正确反映不同作用力的综合结果，须先考虑改变逆指标数据性质，使所有指标对测评方案的作用力同趋化，再加总才能得出正确结果。

Ps8：梯度下降属于机器学习算法中，迭代法的一种，“步长”指沿着梯度方向迈出的步伐大小，即通过此迭代法的学习速率。

***

### 2. 拆分数据集

输入：经过预处理的数据集（共11703条）。

输出：测试数据集（最后1500条）、验证数据集（任意3000条）、训练数据集（其余的7203条）。

主要过程：使用留出法将数据集划分为三个互斥的集合。

***

Ps1：在机器学习中，一般将样本分成独立的三部分训练集，验证集和测试集。

Ps2：训练集用于训练或估计模型。

Ps3：验证集用来确定网络结构或者控制模型复杂程度的参数、测试泛化能力。

Ps4：测试集用来检验最终选择最优的模型的性能，评估泛化误差。

***

### 3. BP神经网络的构建及训练

输入：经过拆分的数据集。

输出：训练集和验证集的损失结果、公交车的预测停站时间。

主要过程：

1. 参数初始化:对输入层节点数量、隐藏层节点数量、输出层节点数量以及学习率进行初始化。
2. 权重初始化:对输入层到隐藏层的权重和隐藏层到输出层的权重进行初始化。
3. 设置激活函数:选择 Sigmoid 函数作为激活函数。
4. 传入参数:将隐藏层神经元数量、输出层神经元数量以及学习率传入函数完成调用。
5. 训练网络:定义神经网络的结构和正向传播的输出结果，定义损失函数以及选择反向传播优化的算法，生成会话并且在训练数据上进行迭代，输出训练过程。
6. 输出结果:调用 MSE 函数来计算均方误差，最后输出训练集和验证集的损失结果及预测时间。

***

Ps1：BP神经网络是1986年由以鲁姆哈特和麦克利兰为首的科学家提出的概念，是一种按照误差逆向传播算法训练的多层前馈神经网络，是目前应用最广泛的神经网络。

Ps2：一个经典的神经网络的结构是包含三个层次的，分为输入层、输出层和隐藏层。输入层有3个输入单元，隐藏层有4个单元，输出层有2个单元，对于不同的神经网络，输入层与输出层的节点数往往是固定的，隐藏层则可以自由指定。

Ps3：所谓激活函数，就是在人工神经网络的神经元上运行的函数，负责将神经元的输入映射到输出端。激活函数可以给神经元引入非线性因素，使得神经网络可以任意逼近任何非线性函数，这样神经网络就可以应用到众多的非线性模型中。

Ps4：Sigmoid函数是一个在生物学中常见的S型函数，也称为S型生长曲线。在信息科学中，由于其单增以及反函数单增等性质，Sigmoid函数常被用作神经网络的阈值函数，将变量映射到0,1之间。

Ps5：学习率作为监督学习以及深度学习中重要的超参数，其决定着目标函数能否收敛到局部最小值以及何时收敛到最小值。合适的学习率能够使目标函数在合适的时间内收敛到局部最小值。

Ps6：在机器学习的上下文中，超参数是在开始学习过程之前设置值的参数，而不是通过训练得到的参数数据。

Ps7：正向传播：输入样本－>输入层－>各隐层（处理）－>输出层

Ps8：误差反向传播：输出误差（某种形式）->隐层（逐层）->输入层

其主要目的是通过将输出误差反传，将误差分摊给各层所有单元，从而获得各层单元的误差信号，进而修正各单元的权值。

Ps9：网络训练的过程，实质上就是权值调整的过程。

Ps10：MSE是网络的性能函数,即求取网络的均方误差的函数。

***

### 4. 预测结果的处理

输入：公交车的预测停站时间、公交车辆的停靠时间以及上车人数。

输出：预测的等待乘客数。

主要过程：

1. 建立回归方程:另外收集数据，在公交车辆的停靠时间以及上车人数的记录中任取10组数据，将前七组作为训练数据，后三组作为测试数据进行线性回归并建立回归方程。

2. 预测结果处理:将公交车的预测停站时间代入上述回归方程，求取出预测的等待乘客数。

***

Ps1：LinearRegression函数的作用是计算线性回归。

Ps2：fit函数的作用是实现线性回归的数据拟合。

Ps3：score函数的作用是评价拟合程度的好坏。

***

### 5. 配车数与发车间隔的计算

输入：预测的等待乘客数、车型定员及计划满载率。

输出：线路配车数与发车间隔。

主要过程：将预测的等待乘客数、首末站停车时间、单程行驶时间、车型定员及计划满载率代入下列两个公式。
$$
\text{线路配车数}=\frac{\text{等待乘客数}\times(\text{首末站停车时间}+\text{单程行驶时间})}{30\times\text{车型定员}\times\text{计划满载率}}
$$

$$
\text{发车间隔}=\frac{60\times\text{车型定员}\times\text{计划满载率}}{等待乘客数}
$$

***

Ps1：首末站停车时间及单程行驶时间在第一部分就已经输入。

Ps2：公式改编自《基于神经网络客流预测的高峰期公交时刻表优化》（谷金晶、江志彬）

*******

### 6. 成本计算与对比

输入：等车时间费用、在车时间费用权重值、初次候车时间价值、在车时间转换为乘客出行费用的系数、该时段内站点等候乘客数、发车间隔、乘客平均等车时间乘客出行的平均里程、该线路的公交车辆的运行平均速度、公交损失系数、公交车在单位时间内行驶损失的成本、调度周期内该线路公交车辆的运营里程数、特定时段内行车总时间、发车间隔、乘客出行成本占总运营成本的权重值和企业运营成本占总运营成本的权重值。

输出：不同时段的优化前后乘客出行成本、公交运营成本及综合成本。

主要过程：将所需数据代入下列三个公式，并进行比较。
$$
Z_1=\alpha_1C_1X\cdot\frac{h}{2}+\beta_1C_2X\cdot\frac{l}{v}
$$

$$
Z_2=C_0L\frac{H}{h}
$$

$$
Z=\alpha_0Z_1+\beta_0Z_2
$$

***

Ps1：$\alpha_1$，$\beta_1$ 分别为等车时间费用、在车时间费用权重值；$c_1$，$c_2$ 为初次候车时间价值、在车时间转换为乘客出行费用的系数，单位为元/分钟；$X$ 是该时段内站点等候乘客数，单位为人；$h$ 为发车间隔，单位为分钟，$\frac{h}{2}$为乘客平均等车时间；$l$ 是乘客出行的平均里程，单位为 km；$v$ 为该线路的公交车辆的运行平均速度，单位为 km/h。

Ps2：$c_0$ 为公交损失系数，公交车在单位时间内行驶损失的成本；$L$ 为调度周期内该线路公交车辆的运营里程数，单位为 km；$H$ 为特定时段内行车总时间，单位为分钟；$h$ 为发车间隔，单位为分钟。

Ps3：$\alpha_0$，$\beta_0$ 分别为乘客出行成本和企业运营成本占总运营成本的权重值。

Ps4：上述公式同样改编自《基于神经网络客流预测的高峰期公交时刻表优化》（谷金晶、江志彬）

Ps5：在综合考虑乘客出行成本和公交运营成本情况下，小程度地增加乘客出行成本，可相对多地减少运营成本，这对于公交公司是有益的。所以此优化方案可供公交公司参考以制定公交发车时刻表。
